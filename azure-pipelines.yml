trigger:
  branches:
    include:
    - master
  tags:
    include:
    - v*

variables:
  SRC_TAG: master

jobs:
- job: Checkout
  pool:
    vmImage: ubuntu-16.04
  steps:
  - task: Bash@3
    displayName: Get wgpu src
    inputs:
      targetType: inline
      script: |
        set -ex
        git clone -b $(SRC_TAG) https://github.com/gfx-rs/wgpu.git
  - task: PublishBuildArtifacts@1
    displayName: Publish
    inputs:
      pathtoPublish: wgpu
      artifactName: wgpu
- job: Build
  dependsOn: Checkout
  strategy:
    matrix:
      Linux:
        vmImage: ubuntu-16.04
        RUST_TOOLCHAIN: stable
        ARCH: 64
        OS_NAME: linux
        IMAGE: manylinux2010_x86_64
      Linux-32:
        vmImage: ubuntu-16.04
        RUST_TOOLCHAIN: stable-i686-unknown-linux-gnu
        ARCH: 32
        OS_NAME: linux
        IMAGE: manylinux2010_i686
      MacOS:
        vmImage: macOS-10.14
        RUST_TOOLCHAIN: stable
        ARCH: 64
        OS_NAME: macos
        MACOSX_DEPLOYMENT_TARGET: '10.13'
      Windows:
        vmImage: vs2017-win2016
        RUST_TOOLCHAIN: stable-msvc
        ARCH: 64
        OS_NAME: windows
      Windows-32:
        vmImage: vs2017-win2016
        RUST_TOOLCHAIN: stable-i686-pc-windows-msvc
        ARCH: 32
        OS_NAME: windows
  pool:
    vmImage: $(vmImage)
  steps:
  - task: DownloadBuildArtifacts@0
    displayName: Download
    inputs:
      artifactName: wgpu
      downloadPath: .
  - task: Bash@3
    displayName: Docker build
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))
    inputs:
      targetType: inline
      script: |
        set -ex
        CID=$(docker create -t -w /tmp/wgpu -v $PWD/wgpu:/tmp/src:ro quay.io/pypa/$(IMAGE) bash -c "\
          cp -r /tmp/src/. . && \
          rm -rf ./dist && \
          export PATH=/root/.cargo/bin:\$PATH && \
          export USER=root && \
          curl --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain none && \
          rustup toolchain install --no-self-update $(RUST_TOOLCHAIN) && \
          rustup default $(RUST_TOOLCHAIN) && \
          yum install zip -y && \
          make package")
        docker start -ai $CID
        mkdir -p wgpu/dist
        docker cp $CID:/tmp/wgpu/dist/. wgpu/dist/.
        docker rm $CID
  - task: Bash@3
    displayName: Host build
    condition: and(succeeded(), ne(variables['Agent.OS'], 'Linux'))
    inputs:
      targetType: inline
      script: |
        set -ex
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path --default-toolchain none
        export PATH=$HOME/.cargo/bin:$PATH
        rustup toolchain install --no-self-update $(RUST_TOOLCHAIN)
        rustup default $(RUST_TOOLCHAIN)
        cd wgpu
        make package
  - task: Bash@3
    displayName: Pre-publish
    inputs:
      targetType: inline
      script: |
        set -ex
        mkdir -p ./dist
        mv wgpu/dist/*release*.zip ./dist/wgpu-$(OS_NAME)-$(ARCH)-release.zip
  - task: PublishBuildArtifacts@1
    displayName: Publish
    inputs:
      pathtoPublish: dist
      artifactName: dist
- job: Release
  dependsOn: Build
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), ne(variables['Build.SourceBranchName'], 'master'))
  pool:
    vmImage: ubuntu-16.04
  steps:
  - task: DownloadBuildArtifacts@0
    displayName: Download
    inputs:
      artifactName: dist
      downloadPath: .
  - task: GithubRelease@1
    displayName: GitHub
    inputs:
      gitHubConnection: github.com_Korijn
      repositoryName: 'Korijn/wgpu-bin'
      assets: |
        dist/*.zip
      action: edit
      tag: $(Build.SourceBranchName)
      addChangeLog: false
      assetUploadMode: delete
